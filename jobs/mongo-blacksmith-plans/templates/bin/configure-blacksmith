#!/bin/bash
set -eu

PLANSRC=/var/vcap/jobs/mongo-blacksmith-plans/plans
SVCROOT=/var/vcap/data/blacksmith/mongo-forge/services
rm    -rf $SVCROOT
mkdir -p  $SVCROOT

# Copy the service definition stub for Blacksmith
cp $PLANSRC/service.yml $SVCROOT

<% p('plans').each do |id, plan| %>
<% name = plan["name"] || id
   raise "Plan ID '#{id}' is invalid; is invalid; names should only contain letters, numbers and hyphens."     unless   id.match(/^[a-zA-z0-9-]+$/)
   raise "Plan Name '#{name}' is invalid; is invalid; names should only contain letters, numbers and hyphens." unless name.match(/^[a-zA-z0-9-]+$/)
%>
##############################################
#
# Set up plan <%= id %>
#
PLANROOT="$SVCROOT/<%= id %>"
PLANTYPE="<%= plan["type"] || 'standalone' %>"

mkdir -p $PLANROOT
cat > $PLANROOT/plan.yml <<EOF
---
id: <%= id %>
name: <%= name %>
limit: <%= plan["limit"] || 0 %>
description: |+
  <%= plan["description"] || 'no description provided' %>
EOF

for file in init credentials.yml manifest.yml; do
  cp $PLANSRC/$PLANTYPE/$file $PLANROOT/
done
chmod 0755 $PLANROOT/init

cat > $PLANROOT/params.yml <<EOF
---
# auto-generated by mongo-blacksmith-plans
# for plan-id <%= id %> (<%= name %>)
meta:
  size: <%= plan["vm_type"] || 'default' %>
EOF



<% end %>
